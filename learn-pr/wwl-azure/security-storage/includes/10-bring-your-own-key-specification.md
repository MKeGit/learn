## Scenario

A Key Vault customer would like to securely transfer a key from their on-premises Hardware Security Module (HSM) outside Azure, into the HSM backing Azure Key Vault. The process of importing a key generated outside Key Vault is referred to as Bring Your Own Key (BYOK).

The following are the requirements:

 -  The key to be transferred never exists outside an HSM in plain text form.
 -  Outside an HSM, the key to be transferred is always protected by a key held in the Azure Key Vault HSM.

## Terminology

| **Key Name**           | **Key Type**                    | **Origin**          | **Description**                                         |
| ---------------------- | ------------------------------- | ------------------- | ------------------------------------------------------- |
| Key Exchange Key (KEK) | RSA                             | Azure Key Vault HSM | An HSM backed RSA key pair generated in Azure Key Vault |
| Wrapping Key           | AES                             | Vendor HSM          | An \[ephemeral\] AES key generated by HSM on-premises   |
| Target Key             | RSA, EC, AES (Managed HSM only) | Vendor HSM          | The key to be transferred to the Azure Key Vault HSM    |

Key Exchange Key (KEK): This is a customer-generated, HSM-backed key within the key vault intended for the import of the BYOK (Bring Your Own Key) key. The KEK should have the following properties:

 -  It must be an RSA-HSM key, with a size of 4096-bit, 3072-bit, or 2048-bit.
 -  Its key operations (key\_ops) are limited to 'import', allowing its use exclusively during the BYOK process.
 -  It must reside in the same vault where the Target Key is to be imported.

## User steps

To perform a key transfer:

1.  Generate KEK.
2.  Retrieve the public key of the KEK.
3.  Using HSM vendor provided BYOK tool, import the KEK into the target HSM and exports the Target Key protected by the KEK.
4.  Import the protected Target Key to Azure Key Vault.

Customers use the BYOK tool and documentation provided by HSM vendor to complete Steps 3. It produces a Key Transfer Blob (a ".byok" file).

## HSM constraints

The existing HSM may apply constraints on key that they manage, including:

 -  The HSM may need to be configured to allow key wrap-based export<br>
 -  The target key may need to be marked **Cryptoki Attribute (CKA)**\_EXTRACTABLE for the HSM to allow controlled export
 -  In some cases, the KEK and wrapping key may need to be marked as CKA\_TRUSTED, which allows it to be used to wrap keys in the HSM.

The configuration of source HSM is, generally, outside the scope of this specification. Microsoft expects the HSM vendor to produce documentation accompanying their BYOK tool to include any such configuration steps.

> [!NOTE]
> Several of these steps can be performed using other interfaces such as Azure PowerShell and Azure portal. They can also be performed programmatically using equivalent functions in Key Vault SDK.

### Generate KEK

Use the **az keyvault key create** command to create KEK with key operations set to import. Note down the key identifier 'kid' returned from the below command.

```azurecli
az keyvault key create --kty RSA-HSM --size 4096 --name KEKforBYOK --ops import --vault-name ContosoKeyVaultHSM




```

Services support different KEK lengths; Azure SQL, for instance, only supports key lengths of 2048 or 3072 bytes.

### Retrieve the public key of the KEK<br>

Download the public key portion of the KEK and store it into a PEM file.

```azurecli
az keyvault key download --name KEKforBYOK --vault-name ContosoKeyVaultHSM --file KEKforBYOK.publickey.pem




```

## Generate key transfer blob using HSM vendor provided BYOK tool<br>

Use the HSM Vendor provided BYOK tool to create a key transfer blob (stored as a ".byok" file). KEK public key as a **.Privacy-Enhanced Mail** (.pem file) will be one of the inputs to this tool.

### Key Transfer Blob

Long term, Microsoft would like to use PKCS\#11 CKM\_RSA\_AES\_KEY\_WRAP mechanism to transfer the target key to Azure Key Vault since this mechanism produces a single blob and, more importantly, the intermediate AES key is handled by the two HSMs and is guaranteed to be ephemeral. This mechanism isn't presently available in some HSMs but the combination of protecting the target key with CKM\_AES\_KEY\_WRAP\_PAD using an AES key and protecting the AES key with CKM\_RSA\_PKCS\_OAEP produces an equivalent blob.

The target key plaintext depends on the key type:

 -  For an RSA key, the private key ASN.1 DER encoding \[RFC3447\] wrapped in PKCS\#8 \[RFC5208\]
 -  For an EC key, the private key ASN.1 DER encoding \[RFC5915\] wrapped in PKCS\#8 \[RFC5208\]
 -  For an octet key, the raw bytes of the key

The bytes for the plaintext key are then transformed using the CKM\_RSA\_AES\_KEY\_WRAP mechanism:

 -  An ephemeral AES key is generated and encrypted with the wrapping RSA key using RSA-OAEP with SHA1.
 -  The encoded plaintext key is encrypted using the AES key using AES Key Wrap with Padding.
 -  The encrypted AES key and the encrypted plaintext key are concatenated to produce the final ciphertext blob.

The format of the transfer blob uses JSON Web Encryption compact serialization (RFC7516) primarily as a vehicle for delivering the required metadata to the service for correct decryption.
